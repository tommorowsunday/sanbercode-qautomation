{"version":3,"file":"metadata.js","sourceRoot":"","sources":["../src/metadata.ts"],"names":[],"mappings":"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","sourcesContent":["import { browser } from '@wdio/globals'\n\nimport { NOT_KNOWN } from './constants.js'\nimport type { AppData, BrowserData, MetadataObject, cjson_metadata } from './types'\nimport type { DesiredCapabilitiesExtended, RunnerStatsExtended, W3CCapabilitiesExtended, WebdriverIOExtended } from './types/wdio'\n\nexport class Metadata {\n    /**\n     * Determine the metadata that needs to be added\n     */\n    public determineMetadata ( data: RunnerStatsExtended ): MetadataObject {\n        let instanceData: AppData | BrowserData\n        const currentCapabilities = data.capabilities as W3CCapabilitiesExtended\n        const optsCaps = browser.options.capabilities as W3CCapabilitiesExtended\n        const currentConfigCapabilities = data?.capabilities as DesiredCapabilitiesExtended\n        const w3cCaps: cjson_metadata = Object.prototype.hasOwnProperty.call( data.config.capabilities, 'cjson:metadata' )\n            // Fixes: https://github.com/webdriverio-community/wdio-cucumberjs-json-reporter/issues/73\n            ? data.config.capabilities['cjson:metadata'] as cjson_metadata\n            // Fallback\n            : ( browser.options as WebdriverIOExtended )?.requestedCapabilities?.cjson_metadata\n        const metadata: cjson_metadata = ( currentConfigCapabilities as W3CCapabilitiesExtended )?.cjson_metadata\n            || w3cCaps // When an app is used to test\n            || ( optsCaps as DesiredCapabilitiesExtended )?.cjson_metadata // devtools\n            || {} as cjson_metadata\n\n        // When an app is used to test\n        if ( currentConfigCapabilities?.app || metadata?.app ) {\n            instanceData = this.determineAppData( currentConfigCapabilities, metadata )\n        } else {\n            // Then a browser\n            instanceData = this.determineBrowserData( currentCapabilities, currentConfigCapabilities, metadata )\n        }\n\n        return <MetadataObject>{\n            ...instanceData,\n            device: this.determineDeviceName( metadata, currentConfigCapabilities ),\n            platform: {\n                name: this.determinePlatformName( metadata, currentCapabilities ),\n                version: this.determinePlatformVersion( metadata, currentCapabilities ),\n            },\n        }\n    }\n\n    /**\n     * Determine the device name\n     */\n    public determineDeviceName ( metadata: cjson_metadata, currentConfigCapabilities: WebDriver.DesiredCapabilities ): string {\n        return ( metadata?.device || currentConfigCapabilities?.deviceName || `Device name ${NOT_KNOWN}` )\n    }\n\n    /**\n     * Determine the platform name\n     */\n    public determinePlatformName ( metadata: cjson_metadata, currentCapabilities: WebDriver.DesiredCapabilities ): string {\n        const currentPlatformName = currentCapabilities?.platformName\n            ? currentCapabilities?.platformName.includes( 'mac' )\n                ? 'osx'\n                : currentCapabilities.platformName.includes( 'windows' )\n                    ? 'windows'\n                    : currentCapabilities?.platformName\n            : `Platform name ${NOT_KNOWN}`\n        return ( metadata.platform && metadata?.platform?.name )\n            ? metadata.platform?.name\n            : currentPlatformName\n    }\n\n    /**\n     * Determine the platform version\n     */\n    public determinePlatformVersion( metadata: cjson_metadata, currentCapabilities?: WebDriver.DesiredCapabilities ): string {\n        if ( metadata && metadata.platform && metadata.platform?.version ) {\n            return metadata.platform.version\n        }\n        if ( currentCapabilities?.platformVersion ) {\n            return currentCapabilities.platformVersion\n        }\n        return `Version ${NOT_KNOWN}`\n    }\n\n    /**\n     * Determine the app data\n     */\n    public determineAppData ( currentConfigCapabilities: DesiredCapabilitiesExtended, metadata: cjson_metadata ): AppData {\n        const metaAppName: string = ( metadata?.app && metadata.app?.name ) ? metadata?.app?.name : 'No metadata.app.name available'\n        const metaAppVersion: string = ( metadata?.app && metadata.app.version ) ? metadata.app.version : 'No metadata.app.version available'\n        const appPath = currentConfigCapabilities.app || metaAppName\n        const appName = appPath.substring( appPath.replace( '\\\\', '/' ).lastIndexOf( '/' ) ).replace( '/', '' )\n\n        return {\n            app: {\n                name: appName,\n                version: metaAppVersion,\n            },\n        }\n    }\n\n    /**\n     * Determine the browser data\n     */\n    public determineBrowserData ( currentCapabilities: WebDriver.DesiredCapabilities, currentConfigCapabilities: WebDriver.DesiredCapabilities, metadata: cjson_metadata ): BrowserData {\n        const browserName = currentCapabilities?.browserName\n            || currentConfigCapabilities?.browserName\n            || ( ( metadata && metadata?.browser && metadata.browser?.name ) ? metadata?.browser?.name : 'No metadata.browser.name available' )\n        const browserVersion = currentCapabilities?.version\n            || currentCapabilities?.browserVersion\n            || currentConfigCapabilities?.browserVersion\n            || ( ( metadata && metadata?.browser && metadata?.browser?.version ) ? metadata?.browser?.version : 'No metadata.browser.version available' )\n\n        return <BrowserData>{\n            browser: {\n                name: browserName,\n                version: browserVersion,\n            }\n        }\n    }\n}\n"]}